#!/usr/bin/env python3
"""
Git pre-commit hook: Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° ÑĞµĞºÑ€ĞµÑ‚Ñ–Ğ² Ğ·Ğ° Ğ´Ğ¾Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ¾Ñ gitleaks.
Ğ Ñ–Ğ²ĞµĞ½ÑŒ: Middle

ĞœĞ¾Ğ¶Ğ»Ğ¸Ğ²Ğ¾ÑÑ‚Ñ–:
  - ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ğµ Ğ²ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ gitleaks Ğ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¾ Ğ²Ñ–Ğ´ ĞĞ¡
  - Ğ£Ğ²Ñ–Ğ¼ĞºĞ½ĞµĞ½Ğ½Ñ/Ğ²Ğ¸Ğ¼ĞºĞ½ĞµĞ½Ğ½Ñ Ñ‡ĞµÑ€ĞµĞ· git config
  - Ğ¡ĞºĞ°Ğ½ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ»Ğ¸ÑˆĞµ staged Ñ„Ğ°Ğ¹Ğ»Ñ–Ğ²
  - Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ Ğ·Ğ²Ñ–Ñ‚ Ğ¿Ñ€Ğ¾ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ– ÑĞµĞºÑ€ĞµÑ‚Ğ¸

Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ:
    cp pre-commit .git/hooks/pre-commit
    chmod +x .git/hooks/pre-commit

Ğ£Ğ²Ñ–Ğ¼ĞºĞ½ĞµĞ½Ğ½Ñ/Ğ²Ğ¸Ğ¼ĞºĞ½ĞµĞ½Ğ½Ñ:
    git config hooks.gitleaks.enable true   # ÑƒĞ²Ñ–Ğ¼ĞºĞ½ÑƒÑ‚Ğ¸ (Ğ·Ğ° Ğ·Ğ°Ğ¼Ğ¾Ğ²Ñ‡ÑƒĞ²Ğ°Ğ½Ğ½ÑĞ¼)
    git config hooks.gitleaks.enable false  # Ğ²Ğ¸Ğ¼ĞºĞ½ÑƒÑ‚Ğ¸
"""

import subprocess
import sys
import shutil
import os
import json
import tempfile
import platform
import urllib.request


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ĞšĞ¾Ğ»ÑŒĞ¾Ñ€Ğ¸ Ğ´Ğ»Ñ Ñ‚ĞµÑ€Ğ¼Ñ–Ğ½Ğ°Ğ»Ğ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

class Color:
    RED    = "\033[91m"
    GREEN  = "\033[92m"
    YELLOW = "\033[93m"
    CYAN   = "\033[96m"
    BOLD   = "\033[1m"
    RESET  = "\033[0m"

def red(text):    return f"{Color.RED}{text}{Color.RESET}"
def green(text):  return f"{Color.GREEN}{text}{Color.RESET}"
def yellow(text): return f"{Color.YELLOW}{text}{Color.RESET}"
def cyan(text):   return f"{Color.CYAN}{text}{Color.RESET}"
def bold(text):   return f"{Color.BOLD}{text}{Color.RESET}"

def print_banner(title: str, color_fn=None) -> None:
    if color_fn is None:
        color_fn = cyan
    line = "â”€" * 60
    print(f"\n{color_fn(line)}")
    print(f"{color_fn('  ' + title)}")
    print(f"{color_fn(line)}\n")


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ git config enable/disable â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def is_hook_enabled() -> bool:
    """
    ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ” git config hooks.gitleaks.enable
    Ğ¯ĞºÑ‰Ğ¾ Ğ½Ğµ Ğ²ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾ â€” Ğ²Ğ²Ğ°Ğ¶Ğ°Ñ”Ñ‚ÑŒÑÑ ÑƒĞ²Ñ–Ğ¼ĞºĞ½ĞµĞ½Ğ¸Ğ¼ (true Ğ·Ğ° Ğ·Ğ°Ğ¼Ğ¾Ğ²Ñ‡ÑƒĞ²Ğ°Ğ½Ğ½ÑĞ¼).
    """
    result = subprocess.run(
        ["git", "config", "--get", "hooks.gitleaks.enable"],
        capture_output=True,
        text=True,
    )
    # Ğ¯ĞºÑ‰Ğ¾ ĞºĞ»ÑÑ‡ Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ â€” Ğ²Ğ¼Ğ¸ĞºĞ°Ñ”Ğ¼Ğ¾ Ğ·Ğ° Ğ·Ğ°Ğ¼Ğ¾Ğ²Ñ‡ÑƒĞ²Ğ°Ğ½Ğ½ÑĞ¼
    if result.returncode != 0:
        return True

    value = result.stdout.strip().lower()
    return value != "false"


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ğµ Ğ²ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

GITLEAKS_VERSION = "8.18.4"
GITLEAKS_RELEASES = "https://github.com/gitleaks/gitleaks/releases/download"


def get_os_info() -> tuple[str, str]:
    """ĞŸĞ¾Ğ²ĞµÑ€Ñ‚Ğ°Ñ” (os_name, arch) Ğ´Ğ»Ñ Ğ²Ğ¸Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ½Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ±Ñ–Ğ½Ğ°Ñ€Ğ½Ğ¸ĞºĞ°."""
    system = platform.system().lower()
    machine = platform.machine().lower()

    # ĞĞ¾Ñ€Ğ¼Ğ°Ğ»Ñ–Ğ·ÑƒÑ”Ğ¼Ğ¾ Ğ°Ñ€Ñ…Ñ–Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñƒ
    if machine in ("x86_64", "amd64"):
        arch = "x64"
    elif machine in ("aarch64", "arm64"):
        arch = "arm64"
    elif machine in ("armv7l", "armv6l"):
        arch = "armv7"
    else:
        arch = machine

    return system, arch


def install_gitleaks_macos() -> bool:
    """Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ÑÑ” gitleaks Ñ‡ĞµÑ€ĞµĞ· Homebrew Ğ½Ğ° macOS."""
    brew = shutil.which("brew")
    if not brew:
        print(yellow("   Homebrew Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾. Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ñ–Ñ‚ÑŒ Ğ¹Ğ¾Ğ³Ğ¾ Ğ· https://brew.sh"))
        print("   ĞĞ±Ğ¾ Ğ²ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ñ–Ñ‚ÑŒ gitleaks Ğ²Ñ€ÑƒÑ‡Ğ½Ñƒ:")
        print(f"   {GITLEAKS_RELEASES}/v{GITLEAKS_VERSION}/")
        return False

    print("   Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ñ‡ĞµÑ€ĞµĞ· Homebrew...")
    result = subprocess.run(
        ["brew", "install", "gitleaks"],
        capture_output=False,  # Ğ¿Ğ¾ĞºĞ°Ğ·ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑ
    )
    return result.returncode == 0


def install_gitleaks_linux(arch: str) -> bool:
    """Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ÑƒÑ” gitleaks binary Ğ· GitHub Releases Ğ½Ğ° Linux."""
    # Ğ¤Ğ¾Ñ€Ğ¼ÑƒÑ”Ğ¼Ğ¾ URL Ğ´Ğ»Ñ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ
    filename = f"gitleaks_{GITLEAKS_VERSION}_linux_{arch}.tar.gz"
    url = f"{GITLEAKS_RELEASES}/v{GITLEAKS_VERSION}/{filename}"

    install_dir = os.path.expanduser("~/.local/bin")
    os.makedirs(install_dir, exist_ok=True)
    dest = os.path.join(install_dir, "gitleaks")

    print(f"   Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ {filename}...")
    print(f"   URL: {url}")

    try:
        tmp_dir = tempfile.mkdtemp()
        archive_path = os.path.join(tmp_dir, filename)

        # Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ÑƒÑ”Ğ¼Ğ¾ Ğ°Ñ€Ñ…Ñ–Ğ²
        urllib.request.urlretrieve(url, archive_path)

        # Ğ Ğ¾Ğ·Ğ¿Ğ°ĞºĞ¾Ğ²ÑƒÑ”Ğ¼Ğ¾
        subprocess.run(
            ["tar", "-xzf", archive_path, "-C", tmp_dir],
            check=True,
        )

        # ĞšĞ¾Ğ¿Ñ–ÑÑ”Ğ¼Ğ¾ Ğ±Ñ–Ğ½Ğ°Ñ€Ğ½Ğ¸Ğº
        src = os.path.join(tmp_dir, "gitleaks")
        shutil.copy2(src, dest)
        os.chmod(dest, 0o755)

        # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ Ñ‡Ğ¸ ~/.local/bin Ñƒ PATH
        if install_dir not in os.environ.get("PATH", ""):
            print(yellow(f"\n   âš   Ğ”Ğ¾Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ´Ğ¾ ~/.bashrc Ğ°Ğ±Ğ¾ ~/.zshrc:"))
            print(f'   export PATH="$PATH:{install_dir}"')
            print(f"   ĞŸĞ¾Ñ‚Ñ–Ğ¼: source ~/.bashrc\n")

        print(green(f"   âœ”  gitleaks Ğ²ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾ Ñƒ {dest}"))
        return True

    except Exception as e:
        print(red(f"   âœ–  ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ²ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ: {e}"))
        return False
    finally:
        shutil.rmtree(tmp_dir, ignore_errors=True)


def install_gitleaks_windows() -> bool:
    """Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ÑÑ” gitleaks Ğ½Ğ° Windows Ñ‡ĞµÑ€ĞµĞ· winget Ğ°Ğ±Ğ¾ choco."""
    # Ğ¡Ğ¿Ñ€Ğ¾Ğ±ÑƒÑ”Ğ¼Ğ¾ winget (Ğ²Ğ±ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹ Ñƒ Windows 11+)
    if shutil.which("winget"):
        print("   Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ñ‡ĞµÑ€ĞµĞ· winget...")
        result = subprocess.run(
            ["winget", "install", "gitleaks"],
            capture_output=False,
        )
        if result.returncode == 0:
            return True

    # Ğ¡Ğ¿Ñ€Ğ¾Ğ±ÑƒÑ”Ğ¼Ğ¾ Chocolatey
    if shutil.which("choco"):
        print("   Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ñ‡ĞµÑ€ĞµĞ· Chocolatey...")
        result = subprocess.run(
            ["choco", "install", "gitleaks", "-y"],
            capture_output=False,
        )
        return result.returncode == 0

    print(yellow("   Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ñ–Ñ‚ÑŒ gitleaks Ğ²Ñ€ÑƒÑ‡Ğ½Ñƒ:"))
    print(f"   {GITLEAKS_RELEASES}/v{GITLEAKS_VERSION}/")
    return False


def auto_install_gitleaks() -> bool:
    """Ğ’Ğ¸Ğ·Ğ½Ğ°Ñ‡Ğ°Ñ” ĞĞ¡ Ñ– Ğ²ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ÑÑ” gitleaks Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ½Ğ¸Ğ¼ ÑĞ¿Ğ¾ÑĞ¾Ğ±Ğ¾Ğ¼."""
    print_banner("ğŸ“¦  ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ğµ Ğ²ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ gitleaks", color_fn=yellow)

    system, arch = get_os_info()
    print(f"   Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° : {bold(system)}")
    print(f"   ĞÑ€Ñ…Ñ–Ñ‚ĞµĞº.: {bold(arch)}\n")

    if system == "darwin":
        success = install_gitleaks_macos()
    elif system == "linux":
        success = install_gitleaks_linux(arch)
    elif system == "windows":
        success = install_gitleaks_windows()
    else:
        print(red(f"   âœ–  ĞĞµĞ¿Ñ–Ğ´Ñ‚Ñ€Ğ¸Ğ¼ÑƒĞ²Ğ°Ğ½Ğ° ĞĞ¡: {system}"))
        print(f"   Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ñ–Ñ‚ÑŒ gitleaks Ğ²Ñ€ÑƒÑ‡Ğ½Ñƒ: {GITLEAKS_RELEASES}/v{GITLEAKS_VERSION}/")
        success = False

    return success


def check_or_install_gitleaks() -> str:
    """
    ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ” Ğ½Ğ°ÑĞ²Ğ½Ñ–ÑÑ‚ÑŒ gitleaks.
    Ğ¯ĞºÑ‰Ğ¾ Ğ²Ñ–Ğ´ÑÑƒÑ‚Ğ½Ñ–Ğ¹ â€” Ğ½Ğ°Ğ¼Ğ°Ğ³Ğ°Ñ”Ñ‚ÑŒÑÑ Ğ²ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ğ¾.
    ĞŸĞ¾Ğ²ĞµÑ€Ñ‚Ğ°Ñ” ÑˆĞ»ÑÑ… Ğ´Ğ¾ gitleaks Ğ°Ğ±Ğ¾ Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑƒÑ” Ñ…ÑƒĞº.
    """
    # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€Ğ¸Ñ‚Ğ¸ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ğ¸Ğ¹ PATH
    path = shutil.which("gitleaks")
    if path:
        return path

    # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€Ğ¸Ñ‚Ğ¸ ~/.local/bin (Ğ¿Ñ–ÑĞ»Ñ Ğ½Ğ°ÑˆĞ¾Ğ³Ğ¾ Ğ²ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ½Ğ° Linux)
    local_bin = os.path.join(os.path.expanduser("~"), ".local", "bin", "gitleaks")
    if os.path.exists(local_bin):
        return local_bin

    print(yellow("âš   gitleaks Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ â€” ÑĞ¿Ñ€Ğ¾Ğ±ÑƒÑ”Ğ¼Ğ¾ Ğ²ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ğ¾...\n"))

    success = auto_install_gitleaks()

    if not success:
        print(red("\nâœ–  ĞĞµ Ğ²Ğ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ²ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ gitleaks Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ğ¾."))
        print(yellow("   Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ñ–Ñ‚ÑŒ Ğ²Ñ€ÑƒÑ‡Ğ½Ñƒ Ñ‚Ğ° Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ñ–Ñ‚ÑŒ ĞºĞ¾Ğ¼Ñ–Ñ‚."))
        print()
        print(yellow("   Ğ©Ğ¾Ğ± Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğ¸ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºÑƒ Ğ¾Ğ´Ğ½Ğ¾Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ¾:"))
        print("     SKIP_GITLEAKS=1 git commit ...")
        sys.exit(1)

    # Ğ¨ÑƒĞºĞ°Ñ”Ğ¼Ğ¾ Ñ‰Ğµ Ñ€Ğ°Ğ· Ğ¿Ñ–ÑĞ»Ñ Ğ²ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ
    path = shutil.which("gitleaks") or local_bin
    if not os.path.exists(path):
        print(red("âœ–  gitleaks Ğ²ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾ Ğ°Ğ»Ğµ Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ Ñƒ PATH."))
        print(yellow("   ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ñ–Ñ‚ÑŒ Ñ‚ĞµÑ€Ğ¼Ñ–Ğ½Ğ°Ğ» Ñ– ÑĞ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ·Ğ½Ğ¾Ğ²Ñƒ."))
        sys.exit(1)

    print(green(f"\nâœ”  gitleaks ÑƒÑĞ¿Ñ–ÑˆĞ½Ğ¾ Ğ²ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾: {path}"))
    return path


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Staged Ñ„Ğ°Ğ¹Ğ»Ğ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def get_staged_files() -> list[str]:
    """ĞŸĞ¾Ğ²ĞµÑ€Ñ‚Ğ°Ñ” ÑĞ¿Ğ¸ÑĞ¾Ğº staged Ñ„Ğ°Ğ¹Ğ»Ñ–Ğ² (Ğ»Ğ¸ÑˆĞµ Ğ´Ğ¾Ğ´Ğ°Ğ½Ñ–/Ğ·Ğ¼Ñ–Ğ½ĞµĞ½Ñ–)."""
    result = subprocess.run(
        ["git", "diff", "--cached", "--name-only", "--diff-filter=ACM"],
        capture_output=True,
        text=True,
    )
    return [f.strip() for f in result.stdout.splitlines() if f.strip()]


def export_staged_content(staged_files: list[str]) -> str:
    """Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ” staged-Ğ²Ğ¼Ñ–ÑÑ‚ Ñ„Ğ°Ğ¹Ğ»Ñ–Ğ² Ñƒ Ñ‚Ğ¸Ğ¼Ñ‡Ğ°ÑĞ¾Ğ²Ñƒ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ñ–Ñ."""
    tmp_dir = tempfile.mkdtemp(prefix="gitleaks_staged_")
    for filepath in staged_files:
        result = subprocess.run(
            ["git", "show", f":{filepath}"],
            capture_output=True,
        )
        if result.returncode != 0:
            continue
        dest = os.path.join(tmp_dir, filepath)
        os.makedirs(os.path.dirname(dest), exist_ok=True)
        with open(dest, "wb") as f:
            f.write(result.stdout)
    return tmp_dir


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ gitleaks scan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def run_gitleaks(gitleaks_bin: str, scan_dir: str) -> tuple[int, list[dict]]:
    """Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°Ñ” gitleaks Ñ‚Ğ° Ğ¿Ğ¾Ğ²ĞµÑ€Ñ‚Ğ°Ñ” (exit_code, Ğ·Ğ½Ğ°Ñ…Ñ–Ğ´ĞºĞ¸)."""
    report_file = os.path.join(scan_dir, "_gitleaks_report.json")
    cmd = [
        gitleaks_bin, "detect",
        "--source", scan_dir,
        "--report-format", "json",
        "--report-path", report_file,
        "--no-git",
        "--exit-code", "1",
    ]
    result = subprocess.run(cmd, capture_output=True, text=True)
    findings = []
    if os.path.exists(report_file):
        try:
            with open(report_file) as f:
                data = json.load(f)
                findings = data if isinstance(data, list) else []
        except (json.JSONDecodeError, IOError):
            pass
    return result.returncode, findings


def print_findings(findings: list[dict], scan_dir: str) -> None:
    """Ğ’Ğ¸Ğ²Ğ¾Ğ´Ğ¸Ñ‚ÑŒ Ğ·Ğ²Ñ–Ñ‚ Ğ¿Ñ€Ğ¾ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ– ÑĞµĞºÑ€ĞµÑ‚Ğ¸."""
    print_banner("ğŸ”  Ğ—Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ– ÑĞµĞºÑ€ĞµÑ‚Ğ¸", color_fn=red)
    for i, finding in enumerate(findings, start=1):
        raw_file = finding.get("File", "Ğ½ĞµĞ²Ñ–Ğ´Ğ¾Ğ¼Ğ¸Ğ¹ Ñ„Ğ°Ğ¹Ğ»")
        rel_file = os.path.relpath(raw_file, scan_dir) if scan_dir in raw_file else raw_file
        rule        = finding.get("RuleID", "â€”")
        description = finding.get("Description", "â€”")
        secret      = finding.get("Secret", "")
        line        = finding.get("StartLine", "?")
        entropy     = finding.get("Entropy", 0)

        if len(secret) > 8:
            masked = secret[:4] + "*" * (len(secret) - 8) + secret[-4:]
        else:
            masked = "****"

        print(f"  {bold(f'[{i}]')} {red('âœ–')} {bold(rel_file)}:{line}")
        print(f"       ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ¾     : {yellow(rule)}")
        print(f"       ĞĞ¿Ğ¸Ñ        : {description}")
        print(f"       Ğ¡ĞµĞºÑ€ĞµÑ‚      : {red(masked)}")
        print(f"       Ğ•Ğ½Ñ‚Ñ€Ğ¾Ğ¿Ñ–Ñ    : {entropy:.3f}")
        print()


def cleanup(tmp_dir: str) -> None:
    shutil.rmtree(tmp_dir, ignore_errors=True)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ğ“Ğ¾Ğ»Ğ¾Ğ²Ğ½Ğ° Ğ»Ğ¾Ğ³Ñ–ĞºĞ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def main() -> None:
    print_banner("ğŸ”  Gitleaks Pre-Commit Hook  [middle]")

    # 1. ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° SKIP_GITLEAKS
    if os.environ.get("SKIP_GITLEAKS"):
        print(yellow("âš   SKIP_GITLEAKS Ğ²ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾ â€” Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºÑƒ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½Ğ¾."))
        sys.exit(0)

    # 2. ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° git config hooks.gitleaks.enable
    if not is_hook_enabled():
        print(yellow("âš   Hook Ğ²Ğ¸Ğ¼ĞºĞ½ĞµĞ½Ğ¾ Ñ‡ĞµÑ€ĞµĞ· git config (hooks.gitleaks.enable=false)."))
        print(yellow("   Ğ©Ğ¾Ğ± ÑƒĞ²Ñ–Ğ¼ĞºĞ½ÑƒÑ‚Ğ¸: git config hooks.gitleaks.enable true"))
        sys.exit(0)

    # 3. ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ°/Ğ²ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ gitleaks
    gitleaks_bin = check_or_install_gitleaks()
    print(green(f"âœ”  gitleaks: {gitleaks_bin}"))

    # 4. Staged Ñ„Ğ°Ğ¹Ğ»Ğ¸
    staged_files = get_staged_files()
    if not staged_files:
        print(green("âœ”  ĞĞµĞ¼Ğ°Ñ” staged Ñ„Ğ°Ğ¹Ğ»Ñ–Ğ² Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ¸."))
        sys.exit(0)

    print(cyan(f"\n   Staged Ñ„Ğ°Ğ¹Ğ»Ğ¸ ({len(staged_files)}):"))
    for f in staged_files:
        print(f"     â€¢ {f}")
    print()

    # 5. Ğ•ĞºÑĞ¿Ğ¾Ñ€Ñ‚ staged ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚Ñƒ
    print("   ĞŸÑ–Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° staged-ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚Ñƒ...")
    tmp_dir = export_staged_content(staged_files)

    # 6. Ğ¡ĞºĞ°Ğ½ÑƒĞ²Ğ°Ğ½Ğ½Ñ
    print("   Ğ¡ĞºĞ°Ğ½ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ½Ğ° ÑĞµĞºÑ€ĞµÑ‚Ğ¸...\n")
    exit_code, findings = run_gitleaks(gitleaks_bin, tmp_dir)
    cleanup(tmp_dir)

    # 7. Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚
    if exit_code == 0 or not findings:
        print(green("âœ”  Ğ¡ĞµĞºÑ€ĞµÑ‚Ñ–Ğ² Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾. ĞšĞ¾Ğ¼Ñ–Ñ‚ Ğ´Ğ¾Ğ·Ğ²Ğ¾Ğ»ĞµĞ½Ğ¾.\n"))
        sys.exit(0)
    else:
        print_findings(findings, tmp_dir)
        print(red("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"))
        print(red("â•‘  âœ–  ĞšĞĞœĞ†Ğ¢ Ğ’Ğ†Ğ”Ğ¥Ğ˜Ğ›Ğ•ĞĞ â€” Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ†Ñ–Ğ¹Ğ½Ñ– ÑĞµĞºÑ€ĞµÑ‚Ğ¸!      â•‘"))
        print(red("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"))
        print()
        print(yellow("   Ğ©Ğ¾ Ñ€Ğ¾Ğ±Ğ¸Ñ‚Ğ¸:"))
        print("     1. Ğ—Ğ°Ğ¼Ñ–Ğ½Ñ–Ñ‚ÑŒ ÑĞµĞºÑ€ĞµÑ‚Ğ¸ Ğ½Ğ° Ğ·Ğ¼Ñ–Ğ½Ğ½Ñ– ÑĞµÑ€ĞµĞ´Ğ¾Ğ²Ğ¸Ñ‰Ğ° (.env)")
        print("     2. Ğ”Ğ¾Ğ´Ğ°Ğ¹Ñ‚Ğµ .env Ğ´Ğ¾ .gitignore")
        print("     3. Ğ¯ĞºÑ‰Ğ¾ Ñ…Ğ¸Ğ±Ğ½Ğµ ÑĞ¿Ñ€Ğ°Ñ†ÑĞ²Ğ°Ğ½Ğ½Ñ â€” Ğ´Ğ¾Ğ´Ğ°Ğ¹Ñ‚Ğµ ĞºĞ¾Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€:")
        print("          # gitleaks:allow")
        print()
        print(yellow("   Ğ©Ğ¾Ğ± Ñ‚Ğ¸Ğ¼Ñ‡Ğ°ÑĞ¾Ğ²Ğ¾ Ğ²Ğ¸Ğ¼ĞºĞ½ÑƒÑ‚Ğ¸ hook:"))
        print("     git config hooks.gitleaks.enable false")
        print()
        sys.exit(1)


if __name__ == "__main__":
    main()
