#!/usr/bin/env python3
"""
Git pre-commit hook: –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–µ–∫—Ä–µ—Ç—ñ–≤ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é gitleaks.

–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è:
    cp pre-commit .git/hooks/pre-commit
    chmod +x .git/hooks/pre-commit

–ê–±–æ –¥–ª—è –≤—Å—ñ—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ (–≥–ª–æ–±–∞–ª—å–Ω–æ):
    git config --global core.hooksPath ~/.git-hooks
    cp pre-commit ~/.git-hooks/pre-commit
    chmod +x ~/.git-hooks/pre-commit
"""

import subprocess
import sys
import shutil
import os
import json
import tempfile


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ö–æ–ª—å–æ—Ä–∏ –¥–ª—è —Ç–µ—Ä–º—ñ–Ω–∞–ª–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

class Color:
    RED    = "\033[91m"
    GREEN  = "\033[92m"
    YELLOW = "\033[93m"
    CYAN   = "\033[96m"
    BOLD   = "\033[1m"
    RESET  = "\033[0m"

def red(text):    return f"{Color.RED}{text}{Color.RESET}"
def green(text):  return f"{Color.GREEN}{text}{Color.RESET}"
def yellow(text): return f"{Color.YELLOW}{text}{Color.RESET}"
def cyan(text):   return f"{Color.CYAN}{text}{Color.RESET}"
def bold(text):   return f"{Color.BOLD}{text}{Color.RESET}"


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –î–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

def print_banner(title: str, color_fn=cyan) -> None:
    line = "‚îÄ" * 60
    print(f"\n{color_fn(line)}")
    print(f"{color_fn('  ' + title)}")
    print(f"{color_fn(line)}\n")


def check_gitleaks_installed() -> str:
    """–ü–µ—Ä–µ–≤—ñ—Ä—è—î –Ω–∞—è–≤–Ω—ñ—Å—Ç—å gitleaks —É PATH. –ü–æ–≤–µ—Ä—Ç–∞—î —à–ª—è—Ö –∞–±–æ –∑–∞–≤–µ—Ä—à—É—î —Ö—É–∫."""
    path = shutil.which("gitleaks")
    if path:
        return path

    print(red("‚úñ  gitleaks –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ —É PATH."))
    print(yellow("   –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –π–æ–≥–æ –æ–¥–Ω–∏–º –∑—ñ —Å–ø–æ—Å–æ–±—ñ–≤:"))
    print("     ‚Ä¢ macOS:   brew install gitleaks")
    print("     ‚Ä¢ Linux:   https://github.com/gitleaks/gitleaks/releases")
    print("     ‚Ä¢ pip:     pip install gitleaks  (–æ–±–≥–æ—Ä—Ç–∫–∞)")
    print()
    print(yellow("   –©–æ–± –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ:"))
    print("     SKIP_GITLEAKS=1 git commit ...")
    sys.exit(1)


def get_staged_files() -> list[str]:
    """–ü–æ–≤–µ—Ä—Ç–∞—î —Å–ø–∏—Å–æ–∫ staged —Ñ–∞–π–ª—ñ–≤ (–ª–∏—à–µ –¥–æ–¥–∞–Ω—ñ/–∑–º—ñ–Ω–µ–Ω—ñ, –Ω–µ –≤–∏–¥–∞–ª–µ–Ω—ñ)."""
    result = subprocess.run(
        ["git", "diff", "--cached", "--name-only", "--diff-filter=ACM"],
        capture_output=True,
        text=True,
    )
    files = [f.strip() for f in result.stdout.splitlines() if f.strip()]
    return files


def export_staged_content(staged_files: list[str]) -> str:
    """
    –ó–±–µ—Ä—ñ–≥–∞—î staged-–≤–º—ñ—Å—Ç —Ñ–∞–π–ª—ñ–≤ —É —Ç–∏–º—á–∞—Å–æ–≤—É –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é.
    –¶–µ –¥–æ–∑–≤–æ–ª—è—î —Å–∫–∞–Ω—É–≤–∞—Ç–∏ —Å–∞–º–µ —Ç—ñ –∑–º—ñ–Ω–∏, —â–æ –π–¥—É—Ç—å —É –∫–æ–º—ñ—Ç,
    –∞ –Ω–µ –ø–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω —Ä–æ–±–æ—á–æ—ó –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó.
    """
    tmp_dir = tempfile.mkdtemp(prefix="gitleaks_staged_")

    for filepath in staged_files:
        result = subprocess.run(
            ["git", "show", f":{filepath}"],
            capture_output=True,
        )
        if result.returncode != 0:
            continue  # —Ñ–∞–π–ª –º—ñ–≥ –±—É—Ç–∏ –≤–∏–¥–∞–ª–µ–Ω–∏–π –∞–±–æ –±—ñ–Ω–∞—Ä–Ω–∏–π

        dest = os.path.join(tmp_dir, filepath)
        os.makedirs(os.path.dirname(dest), exist_ok=True)
        with open(dest, "wb") as f:
            f.write(result.stdout)

    return tmp_dir


def run_gitleaks(gitleaks_bin: str, scan_dir: str) -> tuple[int, list[dict]]:
    """
    –ó–∞–ø—É—Å–∫–∞—î gitleaks —É —Ä–µ–∂–∏–º—ñ 'detect' –¥–ª—è –≤–∫–∞–∑–∞–Ω–æ—ó –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó.
    –ü–æ–≤–µ—Ä—Ç–∞—î (exit_code, —Å–ø–∏—Å–æ–∫ –∑–Ω–∞—Ö—ñ–¥–æ–∫).
    """
    report_file = os.path.join(scan_dir, "_gitleaks_report.json")

    cmd = [
        gitleaks_bin,
        "detect",
        "--source", scan_dir,
        "--report-format", "json",
        "--report-path", report_file,
        "--no-git",          # –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—è –±–µ–∑ .git ‚Äî —Å–∫–∞–Ω—É—î–º–æ —è–∫ —Ñ–∞–π–ª–∏
        "--exit-code", "1",  # –ø–æ–≤–µ—Ä—Ç–∞—î 1, —è–∫—â–æ –∑–Ω–∞–π–¥–µ–Ω–æ —Å–µ–∫—Ä–µ—Ç–∏
    ]

    result = subprocess.run(cmd, capture_output=True, text=True)

    findings = []
    if os.path.exists(report_file):
        try:
            with open(report_file) as f:
                data = json.load(f)
                findings = data if isinstance(data, list) else []
        except (json.JSONDecodeError, IOError):
            pass

    return result.returncode, findings


def print_findings(findings: list[dict], scan_dir: str) -> None:
    """–í–∏–≤–æ–¥–∏—Ç—å –∑—Ä–æ–∑—É–º—ñ–ª–∏–π –∑–≤—ñ—Ç –ø—Ä–æ –∑–Ω–∞–π–¥–µ–Ω—ñ —Å–µ–∫—Ä–µ—Ç–∏."""
    print_banner("üîê  –ó–Ω–∞–π–¥–µ–Ω—ñ —Å–µ–∫—Ä–µ—Ç–∏", color_fn=red)

    for i, finding in enumerate(findings, start=1):
        # –ù–æ—Ä–º–∞–ª—ñ–∑—É—î–º–æ —à–ª—è—Ö –Ω–∞–∑–∞–¥ –¥–æ –≤—ñ–¥–Ω–æ—Å–Ω–æ–≥–æ
        raw_file = finding.get("File", "–Ω–µ–≤—ñ–¥–æ–º–∏–π —Ñ–∞–π–ª")
        rel_file = os.path.relpath(raw_file, scan_dir) if scan_dir in raw_file else raw_file

        rule        = finding.get("RuleID", "‚Äî")
        description = finding.get("Description", "‚Äî")
        secret      = finding.get("Secret", "")
        line        = finding.get("StartLine", "?")
        commit      = finding.get("Commit", "")

        # –ú–∞—Å–∫—É—î–º–æ —Å–µ–∫—Ä–µ—Ç: –ø–æ–∫–∞–∑—É—î–º–æ –ª–∏—à–µ –ø–µ—Ä—à—ñ 4 —Ç–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 4 —Å–∏–º–≤–æ–ª–∏
        if len(secret) > 8:
            masked = secret[:4] + "*" * (len(secret) - 8) + secret[-4:]
        else:
            masked = "****"

        print(f"  {bold(f'[{i}]')} {red('‚úñ')} {bold(rel_file)}:{line}")
        print(f"       –ü—Ä–∞–≤–∏–ª–æ     : {yellow(rule)}")
        print(f"       –û–ø–∏—Å        : {description}")
        print(f"       –°–µ–∫—Ä–µ—Ç      : {red(masked)}")
        if commit:
            print(f"       –ö–æ–º—ñ—Ç       : {commit}")
        print()


def cleanup(tmp_dir: str) -> None:
    import shutil as _shutil
    _shutil.rmtree(tmp_dir, ignore_errors=True)


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ì–æ–ª–æ–≤–Ω–∞ –ª–æ–≥—ñ–∫–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

def main() -> None:
    print_banner("üîç  Gitleaks Pre-Commit Hook")

    # –ú–æ–∂–ª–∏–≤—ñ—Å—Ç—å –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É —á–µ—Ä–µ–∑ –∑–º—ñ–Ω–Ω—É —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
    if os.environ.get("SKIP_GITLEAKS"):
        print(yellow("‚ö†  SKIP_GITLEAKS –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –ø—Ä–æ–ø—É—â–µ–Ω–æ."))
        sys.exit(0)

    # 1. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ gitleaks
    gitleaks_bin = check_gitleaks_installed()
    print(green(f"‚úî  gitleaks –∑–Ω–∞–π–¥–µ–Ω–æ: {gitleaks_bin}"))

    # 2. –û—Ç—Ä–∏–º–∞—Ç–∏ staged —Ñ–∞–π–ª–∏
    staged_files = get_staged_files()
    if not staged_files:
        print(green("‚úî  –ù–µ–º–∞—î staged —Ñ–∞–π–ª—ñ–≤ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏."))
        sys.exit(0)

    print(cyan(f"   Staged —Ñ–∞–π–ª–∏ ({len(staged_files)}):"))
    for f in staged_files:
        print(f"     ‚Ä¢ {f}")
    print()

    # 3. –ï–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ staged-–∫–æ–Ω—Ç–µ–Ω—Ç —É —Ç–∏–º—á–∞—Å–æ–≤—É –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é
    print("   –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ staged-–∫–æ–Ω—Ç–µ–Ω—Ç—É...")
    tmp_dir = export_staged_content(staged_files)

    # 4. –ó–∞–ø—É—Å—Ç–∏—Ç–∏ gitleaks
    print("   –°–∫–∞–Ω—É–≤–∞–Ω–Ω—è –Ω–∞ —Å–µ–∫—Ä–µ—Ç–∏...\n")
    exit_code, findings = run_gitleaks(gitleaks_bin, tmp_dir)

    # 5. –ü—Ä–∏–±—Ä–∞—Ç–∏ —Ç–∏–º—á–∞—Å–æ–≤—ñ —Ñ–∞–π–ª–∏
    cleanup(tmp_dir)

    # 6. –†–µ–∑—É–ª—å—Ç–∞—Ç
    if exit_code == 0 or not findings:
        print(green("‚úî  –°–µ–∫—Ä–µ—Ç—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –ö–æ–º—ñ—Ç –¥–æ–∑–≤–æ–ª–µ–Ω–æ.\n"))
        sys.exit(0)
    else:
        print_findings(findings, tmp_dir)
        print(red("‚úñ  –ö–æ–º—ñ—Ç –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ ‚Äî –∑–Ω–∞–π–¥–µ–Ω–æ –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω—ñ —Å–µ–∫—Ä–µ—Ç–∏!"))
        print()
        print(yellow("   –©–æ —Ä–æ–±–∏—Ç–∏:"))
        print("     1. –í–∏–¥–∞–ª—ñ—Ç—å –∞–±–æ –∑–∞–º—ñ–Ω—ñ—Ç—å —Å–µ–∫—Ä–µ—Ç–∏ –Ω–∞ –∑–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ (.env)")
        print("     2. –î–æ–¥–∞–π—Ç–µ —Ñ–∞–π–ª –¥–æ .gitignore, —è–∫—â–æ –≤—ñ–Ω –Ω–µ –ø–æ–≤–∏–Ω–µ–Ω —Ç—Ä–µ–∫–∞—Ç–∏—Å—å")
        print("     3. –Ø–∫—â–æ —Ü–µ —Ö–∏–±–Ω–µ —Å–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è ‚Äî –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ:")
        print("          gitleaks detect --baseline-path .gitleaks-baseline.json")
        print("        –∞–±–æ –¥–æ–¥–∞–π—Ç–µ –∫–æ–º–µ–Ω—Ç–∞—Ä  # gitleaks:allow  –ø–æ—Ä—É—á –∑ —Ä—è–¥–∫–æ–º")
        print()
        print(yellow("   –©–æ–± –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É (–ª–∏—à–µ —è–∫—â–æ –≤–ø–µ–≤–Ω–µ–Ω—ñ!):"))
        print("     SKIP_GITLEAKS=1 git commit ...")
        print()
        sys.exit(1)


if __name__ == "__main__":
    main()
